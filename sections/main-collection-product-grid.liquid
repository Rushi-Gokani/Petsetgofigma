{%- liquid
  assign top_padding = section.settings.padding_top | round: 0
  assign bottom_padding = section.settings.padding_bottom | round: 0
  assign path = collection.handle | prepend: '/collections/'
  assign sidebar_menu = section.settings.collection_sidebar_menu
  assign sidebar_links = blank
  assign show_collection_sidebar = false

  if section.settings.show_collection_sidebar and sidebar_menu != blank
    assign sidebar_links = sidebar_menu.links
    if sidebar_links != blank and sidebar_links.size > 0
      assign show_collection_sidebar = true
    endif
  endif
-%}

{% capture categoryNoProducts %}
  <div class="flex w-full flex-col gap-5 py-5 md:items-start">
    <p class="">
      <b class="text-secondary-700">{{ 'sections.collection_template.empty_oops' | t }}</b>
      {{ 'sections.collection_template.empty' | t }}
    </p>
    <button type="button" class="button button--outline-secondary" @click="resetAll">
      {{ 'sections.collection_template.reset' | t }}
    </button>
  </div>
{% endcapture %}

<section class="{% if section.settings.custom_color_scheme %}color-{{ section.settings.color_scheme }} bg-bg-500{% endif %}">
  <div
    id="ProductGridContainer"
    class="content-wrapper animate-on-transition mx-auto"
    x-ref="ProductGridContainer"
    x-data="ProductList('{{ path }}')"
    key="ProductList-{{ collection.id | default: 'all' }}"
    style="padding-top: {{ top_padding }}px; padding-bottom: {{ bottom_padding }}px"
  >

    {% if section.settings.enable_sorting or section.settings.enable_filtering %}
      {% render 'filters',
        results: collection,
        enable_sorting: section.settings.enable_sorting,
        enable_filtering: section.settings.enable_filtering
      %}
    {% endif %}

    <div class="collection-layout flex gap-4 md:gap-6" style="">
      {% if show_collection_sidebar %}
        <!-- Hide theme-based sidebar on mobile -->
        <div class="collection-sidebar__placeholder hidden md:block" aria-hidden="true"></div>
        <aside
          class="collection-sidebar hidden md:block"
          aria-label="{{ section.settings.collection_sidebar_heading | default: 'Collections' }}"
         {% if false %}
         x-data="{
            isStickySupported: CSS.supports('position', 'sticky') || CSS.supports('position', '-webkit-sticky'),
            isMobile: false,
            useFixedFallback: false,
            headerHeight: 70,
            originalTop: 0,
            sidebarWidth: 0,
            scrollY: 0,
            ticking: false,
            debug: false, // Set to true for debugging

            // Get actual header height with fallbacks
            getHeaderHeight() {
              const header = document.querySelector('[data-header]') || document.querySelector('header') || document.querySelector('.header');
              if (header) {
                return header.offsetHeight + 20; // Add small buffer
              }

              // Try CSS variable
              const rootStyle = getComputedStyle(document.documentElement);
              const cssHeaderHeight = rootStyle.getPropertyValue('--header-height');
              if (cssHeaderHeight) {
                return parseFloat(cssHeaderHeight) || 70;
              }

              return 70; // Default fallback
            },

            // Enhanced scroll handler with requestAnimationFrame
            scrollHandler() {
              if (!this.ticking) {
                requestAnimationFrame(() => {
                  this.updateStickyPosition();
                  this.ticking = false;
                });
                this.ticking = true;
              }
            },

            // Update sticky/fixed position
            updateStickyPosition() {
              const sidebar = this.$el;
              const rect = sidebar.getBoundingClientRect();
              const currentScrollY = window.pageYOffset || document.documentElement.scrollTop;

              // Calculate the point where sidebar should become sticky
              const triggerPoint = this.originalTop - this.headerHeight;
              const isPastTrigger = currentScrollY >= triggerPoint;

              if (!this.isStickySupported || (this.isMobile && this.useFixedFallback)) {
                // Use fixed positioning fallback
                if (isPastTrigger && !sidebar.classList.contains('fixed-fallback')) {
                  // Save original dimensions before switching
                  if (!this.sidebarWidth) {
                    this.sidebarWidth = sidebar.offsetWidth;
                  }

                  sidebar.classList.add('fixed-fallback');
                  sidebar.style.position = 'fixed';
                  sidebar.style.top = `${this.headerHeight}px`;
                  sidebar.style.width = `${this.sidebarWidth}px`;
                  sidebar.style.left = `${rect.left}px`;
                  sidebar.style.zIndex = '30';
                } else if (!isPastTrigger && sidebar.classList.contains('fixed-fallback')) {
                  // Remove fixed positioning
                  sidebar.classList.remove('fixed-fallback');
                  sidebar.style.position = '';
                  sidebar.style.top = '';
                  sidebar.style.width = '';
                  sidebar.style.left = '';
                  sidebar.style.zIndex = '';
                }
              }
            },

            // Handle resize events
            resizeHandler() {
              const wasMobile = this.isMobile;
              this.isMobile = window.innerWidth < 768;
              this.headerHeight = this.getHeaderHeight();

              /* // Reset on mobile/tablet transition
              if (wasMobile !== this.isMobile) {
                this.useFixedFallback = !this.isStickySupported || this.isMobile;
                this.sidebarWidth = 0;
                this.originalTop = 0;

                const sidebar = this.$el;
                sidebar.classList.remove('fixed-fallback');
                sidebar.style.position = '';
                sidebar.style.top = '';
                sidebar.style.width = '';
                sidebar.style.left = '';
                sidebar.style.zIndex = '';

                // Recalculate original position
                if (!this.originalTop) {
                  const rect = sidebar.getBoundingClientRect();
                  this.originalTop = rect.top + window.pageYOffset;
                }
              } */

              this.updateStickyPosition();
            },

            init() {
              this.isMobile = window.innerWidth < 768;
              this.headerHeight = this.getHeaderHeight();
              this.useFixedFallback = !this.isStickySupported || this.isMobile;

              // Calculate original position
              const rect = this.$el.getBoundingClientRect();
              this.originalTop = rect.top + window.pageYOffset;

              // Setup event listeners with passive option for performance
              window.addEventListener('scroll', this.scrollHandler.bind(this), { passive: true });
              window.addEventListener('resize', this.resizeHandler.bind(this), { passive: true });

              // Handle orientation changes on mobile
              window.addEventListener('orientationchange', () => {
                setTimeout(() => this.resizeHandler(), 100);
              });

              // Debug info
              if (this.debug) {
                console.log('Sidebar init:', {
                  isStickySupported: this.isStickySupported,
                  isMobile: this.isMobile,
                  useFixedFallback: this.useFixedFallback,
                  headerHeight: this.headerHeight,
                  originalTop: this.originalTop
                });
              }

              // Initial check
              this.updateStickyPosition();
            }
          }"
        {% endif %}
        >
          <div class="collection-sidebar__inner">
            {% if section.settings.collection_sidebar_heading != blank %}
              <h2 class="collection-sidebar__heading">
                {{ section.settings.collection_sidebar_heading }}
              </h2>
            {% endif %}
            <ul class="collection-sidebar__list" role="list">
              {% for link in sidebar_links %}
                {% liquid
                  assign linked_collection = blank
                  if link.type == 'collection_link' or link.type == 'catalog_link'
                    assign linked_collection = link.object
                  endif
                  assign item_image = blank
                  if linked_collection != blank
                    assign item_image = linked_collection.featured_image | default: linked_collection.image
                  endif
                  assign is_active = false
                  if link.current or link.active
                    assign is_active = true
                  elsif collection != blank and linked_collection != blank and linked_collection.id == collection.id
                    assign is_active = true
                  endif
                %}
                <li class="collection-sidebar__item" role="listitem">
                  <a href="{{ link.url }}" class="collection-sidebar__link {% if is_active %}is-active{% endif %}">
                    <span class="collection-sidebar__thumb{% if item_image == blank %} collection-sidebar__thumb--empty{% endif %}">
                      {% if item_image %}
                        {% render 'image',
                          src: item_image,
                          alt: linked_collection.title | default: link.title,
                          loading: 'lazy',
                          index: forloop.index0,
                          container_class: 'collection-sidebar__thumb-media',
                          img_class: 'collection-sidebar__thumb-img'
                        %}
                      {% else %}
                        <span class="collection-sidebar__thumb-fallback">
                          {{ link.title | slice: 0, 1 | upcase }}
                        </span>
                      {% endif %}
                    </span>
                    <span class="collection-sidebar__label">{{ link.title }}</span>
                  </a>
                </li>
              {% endfor %}
            </ul>
          </div>
        </aside>
        
        <!-- Custom Sticky Sidebar for Mobile -->
        <div 
          class="custom-collection-sidebar-wrapper md:hidden"
          x-data="{
            isSticky: false,
            headerHeight: 70,
            sidebarTop: 0,
            
            init() {
              this.headerHeight = this.getHeaderHeight();
              this.$nextTick(() => {
                const sidebar = this.$refs.sidebar;
                const rect = sidebar.getBoundingClientRect();
                this.sidebarTop = rect.top + window.pageYOffset;
              });
              
              window.addEventListener('scroll', () => this.handleScroll(), { passive: true });
              window.addEventListener('resize', () => this.handleResize(), { passive: true });
            },
            
            getHeaderHeight() {
              const header = document.querySelector('[data-header]') || document.querySelector('header') || document.querySelector('.header');
              return header ? header.offsetHeight : 70;
            },
            
            handleScroll() {
              const scrollY = window.pageYOffset || document.documentElement.scrollTop;
              this.isSticky = scrollY > (this.sidebarTop - this.headerHeight - 10);
            },
            
            handleResize() {
              this.headerHeight = this.getHeaderHeight();
              if (window.innerWidth >= 768) {
                this.isSticky = false;
              }
            }
          }"
        >
          <!-- Placeholder to maintain layout when sidebar is sticky -->
          <div 
            class="custom-collection-sidebar-placeholder"
            x-show="isSticky"
            aria-hidden="true"
          ></div>
          
          <aside
            x-ref="sidebar"
            class="custom-collection-sidebar"
            aria-label="{{ section.settings.collection_sidebar_heading | default: 'Collections' }}"
            :class="{ 'is-sticky': isSticky }"
            :style="isSticky ? `top: ${headerHeight}px` : ''"
          >
          <div class="custom-collection-sidebar__inner">
            {% if section.settings.collection_sidebar_heading != blank %}
              <h2 class="custom-collection-sidebar__heading">
                {{ section.settings.collection_sidebar_heading }}
              </h2>
            {% endif %}
            <ul class="custom-collection-sidebar__list" role="list">
              {% for link in sidebar_links %}
                {% liquid
                  assign linked_collection = blank
                  if link.type == 'collection_link' or link.type == 'catalog_link'
                    assign linked_collection = link.object
                  endif
                  assign item_image = blank
                  if linked_collection != blank
                    assign item_image = linked_collection.featured_image | default: linked_collection.image
                  endif
                  assign is_active = false
                  if link.current or link.active
                    assign is_active = true
                  elsif collection != blank and linked_collection != blank and linked_collection.id == collection.id
                    assign is_active = true
                  endif
                %}
                <li class="custom-collection-sidebar__item" role="listitem">
                  <a href="{{ link.url }}" class="custom-collection-sidebar__link {% if is_active %}is-active{% endif %}">
                    <span class="custom-collection-sidebar__thumb{% if item_image == blank %} custom-collection-sidebar__thumb--empty{% endif %}">
                      {% if item_image %}
                        {% render 'image',
                          src: item_image,
                          alt: linked_collection.title | default: link.title,
                          loading: 'lazy',
                          index: forloop.index0,
                          container_class: 'custom-collection-sidebar__thumb-media',
                          img_class: 'custom-collection-sidebar__thumb-img'
                        %}
                      {% else %}
                        <span class="custom-collection-sidebar__thumb-fallback">
                          {{ link.title | slice: 0, 1 | upcase }}
                        </span>
                      {% endif %}
                    </span>
                    <span class="custom-collection-sidebar__label">{{ link.title }}</span>
                  </a>
                </li>
              {% endfor %}
            </ul>
          </div>
        </aside>
        </div>
      {% endif %}

      <div class="flex-1">
      <!-- Mobile Collection Heading -->
      <div class="md:hidden px-0 pt-2 pb-2">
        <h1 class="heading text-lg text-text-500 mb-0">
          {{- collection.title | escape -}}
        </h1>
      </div>
        <div class="flex md:items-start">
          {%- paginate collection.products by section.settings.products_per_page -%}
            {%- if collection.products.size == 0 -%}
              {{ categoryNoProducts }}
            {%- else -%}
              <div class="flex-grow">
                <div
                  data-content-wrapper
                  id="product-grid"
                  style="
                    --cols-sm: {{ section.settings.column_amount_sm }};
                    --cols-md: {{ section.settings.column_amount_md }};
                    --cols-lg: {{ section.settings.column_amount_lg }};
                    --cols-xl: {{ section.settings.column_amount_xl }};
                    --cols-2xl: {{ section.settings.column_amount_2xl }};
                  "
                  class="
                    mb-5 grid grid-cols-[repeat(var(--cols-sm),minmax(0,1fr))] gap-5 transition-opacity duration-100 ease-linear md:mb-16
                    md:grid-cols-[repeat(var(--cols-md),minmax(0,1fr))] lg:grid-cols-[repeat(var(--cols-lg),minmax(0,1fr))]
                    xl:grid-cols-[repeat(var(--cols-xl),minmax(0,1fr))] 2xl:grid-cols-[repeat(var(--cols-2xl),minmax(0,1fr))]
                  "
                  :class="
                    {
                      'opacity-0': isLoadingProducts,
                    }
                  "
                >
                  <!-- pagination-content -->
                  {%- for product in collection.products -%}
                    {% render 'card-product',
                      card_product: product,
                      show_vendor: section.settings.show_vendor,
                      index: forloop.index0,
                      nth_product_large: 5,
                      allow_mobile_wide_card: false,
                      lazy_load: false,
                      badge_position_override: 'top right'
                    %}
                  {%- endfor -%}
                  <!-- end-pagination-content -->
                </div>

                {%- if paginate.pages > 1 and paginate.next -%}
                  <div class="my-7 flex flex-col items-center">
                    <a
                      href="#"
                      x-pagination-trigger="{ 'lastPage': {{ paginate.pages }}, 'autoLoad': true }"
                      class="button btn--size-md button--ghost-primary w-full cursor-pointer text-center md:w-auto pagination-loader"
                      :class="{ 'opacity-0 pointer-events-none': isLoadingProducts }"
                    >
                      <span class="pagination-loader__text">
                        {{ 'general.pagination.load_more_products' | t }}
                      </span>
                      <span class="button__icon button__icon--right top-[1px] text-lg">
                        {%- render 'icon-arrow-bottom' -%}
                      </span>
                    </a>
                    <div
                      x-show="isLoadingProducts"
                      x-transition:enter="transition ease-out duration-300"
                      x-transition:enter-start="opacity-0 transform translate-y-2"
                      x-transition:enter-end="opacity-100 transform translate-y-0"
                      x-transition:leave="transition ease-in duration-200"
                      x-transition:leave-start="opacity-100"
                      x-transition:leave-end="opacity-0"
                      class="flex items-center gap-2 text-sm text-gray-600 mt-2"
                    >
                      <div class="pagination-loader__spinner"></div>
                      <span>Loading more products...</span>
                    </div>
                  </div>
                {%- endif -%}
              </div>
            {%- endif -%}
          {%- endpaginate -%}
          {% if section.settings.enable_sorting or section.settings.enable_filtering %}
            <aside class="relative">
              <div class="absolute end-0 top-[-68px] ms-8 md:ps-2">
                <button
                  type="button"
                  class="button button--filled-primary hidden w-[275px] min-w-[275px] md:inline-flex"
                  @click="$store.productList.toggleFiltersSidebar()"
                >
                  <span
                    x-text="$store.productList.isFiltersSidebarExpanded ? '{{ 'products.facets.filter_hide' | t }}' : '{{ 'products.facets.filter_show' | t }}'"
                  >
                    {{ 'products.facets.filter_hide' | t }}
                  </span>
                  <span class="button__icon ms-3 text-xl">
                    {% render 'icon-filter' %}
                  </span>
                </button>
              </div>

              <div
                class="ms-8 hidden w-[275px] min-w-[275px] overflow-hidden transition-[width,min-width] motion-reduce:transition-none md:sticky md:top-[--scroll-top] md:block"
                :class="
                  {
                    'w-[275px] min-w-[275px] ms-8': $store.productList.isFiltersSidebarExpanded,
                    'w-0 min-w-0 ms-0': !$store.productList.isFiltersSidebarExpanded
                  }
                "
                x-sticky-scroll="
                  {
                    top: 90,
                    bottom: 24,
                  }
                "
              >
                <div
                  id="filters-sidebar"
                  class="w-[275px] min-w-[275px] translate-x-0 transition-transform motion-reduce:transition-none"
                  :class="
                    {
                      'translate-x-full': !$store.productList.isFiltersSidebarExpanded,
                      'translate-x-0': $store.productList.isFiltersSidebarExpanded
                    }
                  "
                  :inert="!$store.productList.isFiltersSidebarExpanded"
                ></div>
              </div>
            </aside>
          {% endif %}
        </div>
      </div>
    </div>

    {% if section.settings.enable_sorting or section.settings.enable_filtering %}
      {% comment %} Needed to offset bottom filters at the bottom {% endcomment %}
      <div class="h-[60px] md:hidden"></div>
    {% endif %}
  </div>
</section>

{% schema %}
{
  "name": "t:sections.main-collection-product-grid.name",
  "class": "section",
  "settings": [
    {
      "type": "range",
      "id": "products_per_page",
      "min": 1,
      "max": 100,
      "step": 1,
      "default": 12,
      "label": "t:sections.main-collection-product-grid.settings.products_per_page.label"
    },
    {
      "type": "range",
      "min": 1,
      "max": 12,
      "step": 1,
      "id": "column_amount_sm",
      "label": "t:sections.main-collection-product-grid.settings.columns.sm.label",
      "info": "t:sections.main-collection-product-grid.settings.columns.sm.info",
      "default": 2
    },
    {
      "type": "range",
      "min": 1,
      "max": 12,
      "step": 1,
      "id": "column_amount_md",
      "label": "t:sections.main-collection-product-grid.settings.columns.md.label",
      "info": "t:sections.main-collection-product-grid.settings.columns.md.info",
      "default": 2
    },
    {
      "type": "range",
      "min": 1,
      "max": 12,
      "step": 1,
      "id": "column_amount_lg",
      "label": "t:sections.main-collection-product-grid.settings.columns.lg.label",
      "info": "t:sections.main-collection-product-grid.settings.columns.lg.info",
      "default": 3
    },
    {
      "type": "range",
      "min": 1,
      "max": 12,
      "step": 1,
      "id": "column_amount_xl",
      "label": "t:sections.main-collection-product-grid.settings.columns.xl.label",
      "info": "t:sections.main-collection-product-grid.settings.columns.xl.info",
      "default": 4
    },
    {
      "type": "range",
      "min": 1,
      "max": 12,
      "step": 1,
      "id": "column_amount_2xl",
      "label": "t:sections.main-collection-product-grid.settings.columns.2xl.label",
      "info": "t:sections.main-collection-product-grid.settings.columns.2xl.info",
      "default": 5
    },
    {
      "type": "header",
      "content": "t:sections.main-collection-product-grid.settings.header__3.content"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "default": false,
      "label": "t:sections.main-collection-product-grid.settings.show_vendor.label"
    },
    {
      "type": "header",
      "content": "t:sections.main-collection-product-grid.settings.header__1.content"
    },
    {
      "type": "checkbox",
      "id": "enable_filtering",
      "default": true,
      "label": "t:sections.main-collection-product-grid.settings.enable_filtering.label",
      "info": "t:sections.main-collection-product-grid.settings.enable_filtering.info"
    },
    {
      "type": "checkbox",
      "id": "enable_sorting",
      "default": true,
      "label": "t:sections.main-collection-product-grid.settings.enable_sorting.label"
    },
    {
      "type": "header",
      "content": "Collection sidebar"
    },
    {
      "type": "checkbox",
      "id": "show_collection_sidebar",
      "default": false,
      "label": "Show collection list"
    },
    {
      "type": "link_list",
      "id": "collection_sidebar_menu",
      "label": "Sidebar menu"
    },
    {
      "type": "text",
      "id": "collection_sidebar_heading",
      "label": "Sidebar heading",
      "default": "Shop by category"
    },
    {
      "type": "header",
      "content": "t:sections.all.colors.header"
    },
    {
      "type": "checkbox",
      "id": "custom_color_scheme",
      "default": false,
      "label": "t:sections.all.custom_color_scheme.label",
      "info": "t:sections.all.custom_color_scheme.info"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:sections.all.colors.label",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "t:sections.all.padding.section_padding_heading"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_top",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_bottom",
      "default": 0
    }
  ]
}
{% endschema %}
