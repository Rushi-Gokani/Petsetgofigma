{% comment %}
  - is_cart_page: {Boolean} - If the cart is being rendered on the cart page
{% endcomment %}

{% capture cartTotalsExpandButton %}
  <button
    type="button"
    class="button button--outline-secondary icon-button icon-button--size-xs {% if is_cart_page %} md:hidden {% endif %}"
    :aria-label="
      isTotalsExpanded
        ? '{{ 'sections.cart.totals.collapse' | t }}'
        : '{{ 'sections.cart.totals.expand' | t }}'
    "
    @click="isNoteExpanded = false; isTotalsExpanded = !isTotalsExpanded"
    @transitionend.stop
    :tabindex="isTotalsExpanded && orderTotal ? -1 : 0"
  >
    <span :class="{ 'rotate-180': isTotalsExpanded }">
      {% render 'icon-chevron-up' %}
    </span>
  </button>
{% endcapture %}

{% capture cartTotalsExpandArea %}
<div
  class="absolute end-0 start-0 top-0 origin-bottom -translate-y-[2.5rem] transition-all duration-700 motion-reduce:transition-none md:mb-0 md:w-full {% if is_cart_page %}md:relative md:translate-y-0 md:pointer-events-auto{% endif %}"
  :class="
    {
      '-translate-y-full': isTotalsExpanded,
      '-translate-y-[2.5rem] pointer-events-none': !isTotalsExpanded,
      '-z-10': isNoteExpanded
    }
  "
  {% unless is_cart_page %}
    :style="{
      'clip-path': isTotalsExpanded ? 'inset(0 0 0 0)' : 'inset(0 0 50% 0)'
    }"
  {% endunless %}
>
  <div
    class="pointer-events-none {% if is_cart_page %}md:hidden{% endif %} relative top-0 h-10 bg-gradient-to-t from-[#00000010] via-transparent to-transparent"
  ></div>
  <div
    class="flex flex-col gap-4 bg-bg-500 {% if is_cart_page %}max-md:px-4 md:pb-4{% else %}px-4 pointer-events-none opacity-0 transition-opacity duration-300 delay-200{% endif %} pt-4 [.popup\_\_wrapper--visible_&]:pointer-events-auto [.resizable--visible_&]:pointer-events-auto"
    {% unless is_cart_page %}
    :class="{
      'opacity-0 delay-200': !isTotalsExpanded,
      'opacity-100': isTotalsExpanded
    }"
    {% endunless %}
    :inert="{% if is_cart_page %}$store.main.isMobile && {% endif %}!isTotalsExpanded"
  >
    <div
      class="flex items-center justify-between pt-2"
      x-data="{orderTotal: false}"
    >
      <h2 class="text-text-500">{{ 'customer.order.summary' | t }}</h2>
      {{ cartTotalsExpandButton }}
    </div>
    <div
      class="flex flex-col gap-3 "
    >
      <div class="flex justify-between">
        <p>{{ 'sections.cart.totals.subtotal' | t }}</p>
        <p x-text="$store.cart.subtotalPrice()"></p>
      </div>

      {%- capture discounts -%}
        {%- for discount in cart.cart_level_discount_applications -%}
          {"title": "{{ discount.title | escape }}","total_allocated_amount": {{ discount.total_allocated_amount }}},
        {%- endfor -%}
      {%- endcapture -%}

      {%- capture discounts -%}
        [{{ discounts | remove_last: ',' }}]
      {%- endcapture -%}

      <div
        class="contents"
        x-init='$store.cart.setDiscounts(JSON.parse({{discounts | json}}))'
      >
        <template x-if="$store.cart.discounts">
          <template x-for="(discount, i) in $store.cart.discounts">
            <div class="flex justify-between" :key="`discount-${discount.title}`">
              <p x-text="`{{ 'customer.order.discount' | t }} (${discount.title})`"></p>
              <p x-text="`-${$store.main.getPrice(discount.total_allocated_amount)}`"></p>
            </div>
          </template>
        </template>
      </div>

      {% if cart.taxes_included %}
        <p>
          {{ 'sections.cart.taxes_included_but_shipping_at_checkout' | t }}
        </p>
      {% endif %}
    </div>
    <hr class="divider -mx-4  {% if is_cart_page %}md:hidden{% endif %}">
  </div>
</div>
{% endcapture %}

{% capture cartNoteExpandArea %}
<div
  class="absolute end-0 start-0 top-0 origin-bottom -translate-y-[2.5rem] text-text-500 transition-transform duration-700 motion-reduce:transition-none md:mb-0 md:w-full {% if is_cart_page %}md:relative md:translate-y-0 md:pointer-events-auto{% endif %}"
  :class="
    {
      '-translate-y-full': isNoteExpanded,
      '-translate-y-[2.5rem] pointer-events-none': !isNoteExpanded,
      '-z-10': isTotalsExpanded
    }
  "
>
  <div
    class="pointer-events-none {% if is_cart_page %}md:hidden{% endif %} relative top-0 h-10 bg-gradient-to-t from-[#00000010] via-transparent to-transparent"
  ></div>
  <div
    class="flex flex-col gap-4 bg-bg-500 {% if is_cart_page %}max-md:px-4 md:pb-4 md:border-t md:border-b md:-mx-4 md:px-4{% else %}px-4 pointer-events-none{% endif %} pt-4 [.popup\_\_wrapper--visible_&]:pointer-events-auto [.resizable--visible_&]:pointer-events-auto"
    :inert="{% if is_cart_page %}$store.main.isMobile && {% endif %}!isNoteExpanded"
  >
    {% if is_cart_page %}
      <h2 class="max-md:hidden">{{ 'customer.order.note' | t }}</h2>
    {% endif %}
    <div
      class="flex flex-col gap-3 "
    >
      <label class="sr-only" for="cart-note">{{ 'sections.cart.note' | t }}</label>
      <textarea
        name="note"
        form="CartForm"
        id="cart-note"
        placeholder="{{ 'sections.cart.note' | t }}"
        class="input__field input__field--outline h-auto resize-none py-4"
      >{{ cart.note }}</textarea>
    </div>
    <hr class="divider -mx-4  {% if is_cart_page %}md:hidden{% endif %}">
  </div>
</div>
{% endcapture %}

<div
  {% if cart.empty? %}
    style="display: none"
  {% endif %}
  class="relative px-4 md:rounded-b-md max-md:px-3 overflow-hidden {{ class }}"
  x-show="!isCartEmpty"
  x-ref="CartTotals"
>
  {{ cartTotalsExpandArea }}
  {%- if settings.show_cart_note -%}
    {{ cartNoteExpandArea }}
  {%- endif -%}

  <div
    class="{% if is_cart_page %}p-4{% else %}pointer-events-none px-3{% endif %} relative -mx-4 rounded-b-md bg-bg-500 transition-opacity duration-300 md:pb-4 max-md:px-3 max-md:pb-5 [.popup\_\_main_&]:pb-3 [.popup\_\_wrapper--visible_&]:pointer-events-auto [.resizable--visible_&]:pointer-events-auto"
    :class="
      {
        'opacity-0': isCartEmpty,
        'opacity-1': !isCartEmpty,
        'hidden': isRemoveContent
      }
    "
  >
    {% form 'cart', cart %}
      <div class="flex items-center justify-between overflow-x-hidden bg-bg-500 pb-2 {% unless is_cart_page %}px-2 pt-4{% endunless %} text-text-500 max-md:px-3">
        <h2>{{ 'sections.cart.totals.title' | t }}</h2>
        <div
          class="flex items-center gap-5 transition-transform delay-200 duration-300 motion-reduce:transition-none"
          :class="
            {
              'translate-x-[calc(var(--direction-factor)*2.75rem)]': isTotalsExpanded,
              'translate-x-0 delay-200': !isTotalsExpanded,
            }
          "
          x-data="{orderTotal: true}"
        >
          <div>
            <p class="font-semibold" x-text="$store.cart.totalPrice()" data-cart-subtotal></p>
          </div>
          {{ cartTotalsExpandButton }}
        </div>
      </div>

      {% if is_cart_page %}
        <div class="my-3 max-md:px-3">
          {{ form | payment_terms }}
        </div>
      {% endif %}
    {% endform %}

    <div class="mt-2 flex flex-col gap-4 rounded-b-xl bg-bg-500 max-md:px-3">
      <div class="flex gap-4">
        {%- if settings.show_cart_note -%}
          <button
            class="button button--outline-primary h-11 {% if is_cart_page %} md:hidden {% endif %}"
            :class="{ 'bg-primary-50': isNoteExpanded }"
            @click.prevent="isTotalsExpanded = false; isNoteExpanded = !isNoteExpanded"
            type="button"
          >
            {{ 'sections.cart.add_note' | t }}
            <span class="button__icon ms-3">
              {% render 'icon-note' %}
            </span>
          </button>
        {%- endif -%}

        <button
          type="submit"
          form="CartForm"
          name="checkout"
          class="button button--filled-primary h-11 w-full"
        >
          {{ 'sections.cart.totals.checkout' | t }}
          <span class="button__icon ms-3">
            {% render 'icon-lock' %}
          </span>
        </button>
      </div>

      {%- if additional_checkout_buttons and is_cart_page -%}
        <div class="rte">
          {{ content_for_additional_checkout_buttons }}
        </div>
      {%- endif -%}
    </div>
  </div>
</div>
