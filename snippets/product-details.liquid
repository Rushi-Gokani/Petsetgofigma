{% comment %}
  Mobile Product Details
  ----------------------
  This snippet is responsible for displaying the product details on mobile devices.
{% endcomment %}

{% liquid
  assign is_contain = false
  if settings.fit_products_media == 'contain'
    assign is_contain = true
  endif
%}

{% capture gallery %}
  {% if section.settings.gallery_layout == 'carousel' %}
    <div
      class="relative w-full max-md:-mt-8"
      x-data="productCarousel"
      x-init="init()"
      @touchstart.passive="onTouchStart($event)"
      @touchmove="onTouchMove($event)"
      @touchend="onTouchEnd()"
    >
      <!-- Carousel Container -->
      <div class="relative overflow-hidden rounded-2xl border-black">
        <div
          class="flex transition-transform duration-300 ease-in-out"
          :style="`transform: translateX(-${currentSlide * 100}%)`"
        >
          {% liquid
            assign first_image = product.selected_or_first_available_variant.image
            unless first_image
              assign first_image = product.media | first
            endunless
          %}

          {% if first_image %}
            <div class="w-full flex-shrink-0">
              {% render 'carousel-slide', media: first_image, index: 0, product: product, is_contain: is_contain %}
            </div>
          {% endif %}

          {% if product.media == blank %}
            <div class="w-full flex-shrink-0">
              {% render '_product-missing-image', is_gift: product.gift_card? %}
            </div>
          {% else %}
            {% assign variant_images = product.images | where: 'attached_to_variant?', true | map: 'src' %}
            {% assign slide_index = 1 %}
            {% for media in product.media %}
              {% unless forloop.index0 == 0 and product.selected_or_first_available_variant.image == blank %}
                {% if section.settings.display_gallery_images == 'selected_variant' and variant_images contains media.src %}
                  {% continue %}
                {% endif %}
                <div class="w-full flex-shrink-0">
                  {% render 'carousel-slide', media: media, index: slide_index, product: product, is_contain: is_contain, loop: section.settings.enable_video_looping, autoplay: section.settings.enable_video_autoplay %}
                </div>
                {% assign slide_index = slide_index | plus: 1 %}
              {% endunless %}
            {% endfor %}
          {% endif %}
        </div>

        <!-- Navigation Arrows -->
        {% liquid
          assign total_slides = slide_index
          if first_image
            assign total_slides = slide_index
          else
            assign total_slides = slide_index
          endif
        %}

        <!-- Navigation Arrows Container -->
        <div class="absolute inset-0 flex items-center justify-between px-4 pointer-events-none">
          <!-- Previous Button -->
          <button
            @click="prevSlide()"
            :class="{ 'opacity-50 cursor-not-allowed': currentSlide === 0 }"
            class="pointer-events-auto z-2 flex h-10 w-10 items-center product-slider-arrow justify-center rounded-full bg-white/80 shadow-lg transition-opacity hover:bg-white disabled:opacity-50"
            :disabled="currentSlide === 0"
          >
            {% case section.settings.carousel_icons %}
              {% when 'arrows' %}
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
              {% when 'chevrons' %}
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
                </svg>
              {% when 'large_arrows' %}
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 19l-7-7 7-7"></path>
                </svg>
              {% when 'last_chevrons' %}
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M11 19l-7-7 7-7"></path>
                </svg>
            {% endcase %}
          </button>

          <!-- Next Button -->
          <button
            @click="nextSlide()"
            :class="{ 'opacity-50 cursor-not-allowed': currentSlide === {{ total_slides }} - 1 }"
            class="pointer-events-auto z-2 flex h-10 w-10 items-center justify-center rounded-full product-slider-arrow bg-white/80 shadow-lg transition-opacity hover:bg-white disabled:opacity-50"
            :disabled="currentSlide === {{ total_slides }} - 1"
          >
            {% case section.settings.carousel_icons %}
              {% when 'arrows' %}
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              {% when 'chevrons' %}
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>
                </svg>
              {% when 'large_arrows' %}
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5l7 7-7 7"></path>
                </svg>
              {% when 'last_chevrons' %}
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M13 5l7 7-7 7"></path>
                </svg>
            {% endcase %}
          </button>
        </div>
      </div>

      {% comment  %}
        <!-- Desktop Pagination -->
        {% if section.settings.carousel_pagination == 'counter' %}
          <div class="mt-4 flex justify-center">
            <div class="text-sm text-gray-600 font-medium">
              <span x-text="currentSlide + 1"></span> / {{ total_slides }}
            </div>
          </div>
        {% elsif section.settings.carousel_pagination == 'dots' %}
          <div class="mt-4 hidden md:flex justify-center gap-2">
            {% for i in (0..total_slides) %}
              <button
                @click="goToSlide({{ i }})"
                :class="{ 'bg-black': currentSlide === {{ i }}, 'bg-gray-300': currentSlide !== {{ i }} }"
                class="h-2 w-2 rounded-full transition-colors"
              ></button>
            {% endfor %}
          </div>
        {% elsif section.settings.carousel_pagination == 'thumbnail' %}
          <div class="mt-4 hidden md:flex justify-center gap-2 overflow-x-auto">
            {% assign thumb_index = 0 %}
            {% if first_image %}
              <button
                @click="goToSlide(0)"
                :class="{ 'ring-2 ring-black': currentSlide === 0, 'ring-1 ring-gray-300': currentSlide !== 0 }"
                class="flex-shrink-0 w-16 h-16 rounded-lg overflow-hidden transition-all"
              >
                <img src="{{ first_image | image_url: width: 64, height: 64 }}" alt="{{ first_image.alt | default: product.title }}" class="w-full h-full object-cover">
              </button>
              {% assign thumb_index = 1 %}
            {% endif %}

            {% for media in product.media %}
              {% unless forloop.index0 == 0 and product.selected_or_first_available_variant.image == blank %}
                {% if section.settings.display_gallery_images == 'selected_variant' and variant_images contains media.src %}
                  {% continue %}
                {% endif %}
                <button
                  @click="goToSlide({{ thumb_index }})"
                  :class="{ 'ring-2 ring-black': currentSlide === {{ thumb_index }}, 'ring-1 ring-gray-300': currentSlide !== {{ thumb_index }} }"
                  class="flex-shrink-0 w-16 h-16 rounded-lg overflow-hidden transition-all"
                >
                  {% if media.media_type == 'image' %}
                    <img src="{{ media | image_url: width: 64, height: 64 }}" alt="{{ media.alt | default: product.title }}" class="w-full h-full object-cover">
                  {% else %}
                    <div class="w-full h-full bg-gray-200 flex items-center justify-center">
                      <svg class="h-6 w-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                      </svg>
                    </div>
                  {% endif %}
                </button>
                {% assign thumb_index = thumb_index | plus: 1 %}
              {% endunless %}
            {% endfor %}
          </div>
        {% endif %}
      {% endcomment %}

      <!-- Mobile Pagination -->
      <div class="mt-4 md:hidden">
        {% if section.settings.carousel_mobile_pagination == 'dots' %}
          <div class="flex justify-center gap-2">
            {% for i in (0..total_slides) %}
              <button
                @click="goToSlide({{ i }})"
                :class="{ 'bg-black': currentSlide === {{ i }}, 'bg-gray-300': currentSlide !== {{ i }} }"
                class="h-2 w-2 rounded-full transition-colors"
              ></button>
            {% endfor %}
          </div>
        {% elsif section.settings.carousel_mobile_pagination == 'counter' %}
          <div class="flex justify-center">
            <div class="text-xs text-gray-600">
              <span x-text="currentSlide + 1"></span> / {{ total_slides }}
              <span class="block text-center mt-1">Swipe to navigate</span>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  {% else %}
    <div
      class="flex w-full flex-col gap-4 md:grid md:grid-cols-[repeat(auto-fit,1fr)] md:gap-5 md:pb-7 lg:grid-cols-[repeat(auto-fit,minmax(300px,1fr))] max-md:-mt-8 "
    >
    <!-- First image on desktop -->
    {% liquid
      assign first_image = product.selected_or_first_available_variant.image

      unless first_image
        assign first_image = product.media | first
      endunless
    %}
    {% if first_image %}
      {% assign first_image_id = first_image.id | append: '-desktop-image' %}
      <div
        class="relative flex aspect-product flex-shrink-0 cursor-zoom-in items-center justify-center overflow-hidden border-black bg-[--fade-in-bg] md:rounded-2xl max-md:hidden"
        x-data="ImageZoom"
        @click.stop="zoomImage"
        x-element-transition-dest="desktop-img"
      >
        <div
          x-data="
          TransitionImage({
            src: Alpine.store('transition').pageData?.variantImg || Alpine.store('transition').pageData?.productImg,
            imageId: '{{ first_image_id }}'
          })
        "
        x-show="!!src"
        class="hide-unless-transition absolute inset-0 z-10 flex items-center justify-center bg-[--fade-in-bg] {% if is_contain %}p-[4%]{% endif %} transition-opacity delay-1000 duration-300"
        :class="{ 'opacity-0': isImgLoaded }"
        >
          <img
            height="100%"
            width="100%"
            class="transition-image {% if is_contain %}object-contain rounded-[5%] md:rounded-[3%] max-h-full max-md:w-auto{% else %}object-cover size-full{% endif %} object-center {% if settings.card_gray_background %}mix-blend-darken{% endif %}"
            :src="src"
          >
        </div>
        {% liquid
          assign alt = first_image.alt | default: product.title
          assign class = 'object-center no-fade '
          assign container_class = 'flex items-center justify-center '
          if is_contain
            assign class = class | append: 'object-contain rounded-[5%] md:rounded-[3%] max-h-full max-md:w-auto'
            assign container_class = container_class | append: 'p-[4%] size-full'
          else
            assign class = class | append: 'object-cover size-full'
            assign container_class = container_class | append: 'size-full'
          endif
        %}
        {%
          render 'image',
          src: first_image,
          width: 2048,
          height: 2048,
          id: first_image_id,
          img_class: class,
          container_class: container_class,
          alt: alt,
          is_mix: settings.card_gray_background
        %}
      </div>
    {% endif %}

    {% if product.media == blank %}
      <div
        class="relative flex-shrink-0 overflow-hidden border-black md:rounded-2xl max-md:hidden"
      >
        {% render '_product-missing-image', is_gift: product.gift_card? %}
      </div>
    {% else %}
      {% assign variant_images = product.images | where: 'attached_to_variant?', true | map: 'src' %}
      {% for media in product.media %}
        {% unless forloop.index0 == 0 and product.selected_or_first_available_variant.image == blank %}
          {% if section.settings.display_gallery_images == 'selected_variant' and variant_images contains media.src %}
              {% continue %}
            {% endif %}
          <div
            class="animate-on-transition relative aspect-product flex-shrink-0 cursor-zoom-in overflow-hidden border-black md:rounded-2xl"
            x-data="ImageZoom"
            @click.stop="zoomImage"
            @touchstart="onTouchStart"
            @touchmove="onTouchMove"
            @touchend="onTouchEnd"
            @wheel="onWheel"
            :style="`transform: translate(${translate.x}px, ${translate.y}px) scale(${scale})`"
            :class="{
              'transition-all duration-300': reset,
              'z-50': scale > 1
            }"
          >
            {% liquid
              assign class = 'object-center '
              assign container_class = 'flex items-center justify-center size-full '
              if is_contain
                assign class = class | append: 'object-contain rounded-[5%] md:rounded-[3%] max-h-full w-auto'
                assign container_class = container_class | append: 'p-[4%]'
              else
                assign class = class | append: 'object-cover size-full'
                assign container_class = container_class | append: 'size-full'
              endif
            %}
            {% render 'media',
              media: media,
              class: class,
              container_class: container_class,
              variant_image: true,
              index: forloop.index0,
              title: product.title,
              loop: section.settings.enable_video_looping,
              autoplay: section.settings.enable_video_autoplay
            %}
          </div>
        {% endunless %}
      {% endfor %}
    {% endif %}
  </div>
  {% endif %}
{% endcapture %}

{% capture mobileFeaturedImage %}
  <div
    class="mb-4 md:hidden"
    style="margin-top: {{ settings.mobile_featured_image_margin_top }}px;"
  >
    <div x-element-transition-dest="mobile-img">
      {% liquid
        if product.selected_variant
          assign image = product.selected_variant.image | default: product.featured_image
        else
          assign image = product.featured_image
        endif
      %}
      {% if image %}
        <div
          class="relative z-[50] flex aspect-product min-h-0 justify-center bg-[--fade-in-bg] {% if is_contain %}p-[4%]{% endif %}"
          x-data="ImageZoom"
          @touchstart="onTouchStart"
          @touchmove="onTouchMove"
          @touchend="onTouchEnd"
          @wheel="onWheel"
          :style="`transform: translate(${translate.x}px, ${translate.y}px) scale(${scale})`"
          :class="{
            'transition-all duration-300': reset,
            'z-50': scale > 1
          }"
        >
          {% assign variant_image_id = image.id | append: '-mobile-image' %}
          <div
            class="hide-unless-transition absolute inset-0 z-10 flex items-center justify-center bg-[--fade-in-bg] transition-opacity delay-1000 duration-300 {% if is_contain %}p-[4%]{% endif %}"
            x-data="
              TransitionImage({
                src: ($store['transition'].pageData?.productImg || $store['transition'].pageData?.variantImg),
                imageId: '{{ variant_image_id }}'
              })
            "
            x-show="!!src"
            :class="{ 'opacity-0': isImgLoaded }"
          >
            <img
              height="100%"
              width="100%"
              class="max-h-full object-center {% if is_contain %}object-contain rounded-2xl w-auto{% else %}object-cover size-full{% endif %} {% if settings.card_gray_background %}mix-blend-darken{% endif %}"
              :src="src"
            >
          </div>

          {% liquid
            assign alt = image.alt | default: product.title
            assign class = 'no-fade object-center '
            assign container_class = 'flex items-center justify-center'
            if is_contain
              assign class = class | append: 'max-h-full max-w-full rounded-[5%] md:rounded-[3%] object-contain w-auto'
            else
              # Implement for cover
              assign class = class | append: 'object-cover size-full'
              assign container_class = container_class | append: ' w-full'
            endif
          %}

          {% render 'image',
            id: variant_image_id,
            src: image,
            img_class: class,
            container_class: container_class,
            alt: alt,
            is_mix: settings.card_gray_background,
            width: '100%',
            height: '100%',
          %}

          {% if product %}
            {% assign class = 'md:hidden ' | append: settings.badge_position %}
            {% render '_discount-badge', product: product.selected_or_first_available_variant, class: class %}
          {% endif %}
        </div>
      {% else %}
        {% render '_product-missing-image', is_gift: product.gift_card? %}
      {% endif %}
    </div>
  </div>
{% endcapture %}

<div class="md:content-wrapper relative z-10 mx-auto flex w-full flex-col justify-center gap-4 md:grid md:grid-cols-[1fr_250px] md:items-start md:gap-8 lg:grid-cols-[1fr_330px] xl:grid-cols-[1fr_400px] xl:gap-16">
  <div class="contents max-md:hidden">
    {{ gallery }}
  </div>

  <div class="contents md:hidden">
    {{ gallery }}
  </div>

  <div
    class="product-details md:sticky md:top-[--scroll-top] md:pb-7"
    {% if section.settings.enable_sticky_info %}
      x-sticky-scroll="
        {
          container: $refs.scrollContainer,
          top: $refs.scrollContainer ? (window.innerHeight > 1080 ? 24 : 72) : 90,
          bottom: $refs.scrollContainer ? (window.innerHeight > 1080 ? 300 : 100) : 24,
        }
      "
    {% endif %}
  >
    {% render 'product-details-info', product: product %}
  </div>
</div>
